var k=Object.defineProperty;var B=(e,t,s)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var l=(e,t,s)=>(B(e,typeof t!="symbol"?t+"":t,s),s);import{c as E,a as U}from"./vendor.df750a5e.js";const H=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}};H();const z=["active","movement","body","shape"],G=["movement","body","shape"],x=["attractor","body","shape"],W=["active","movement","body"],A=["movement","body"],F=["attractor","body"],X=["target"],j=(e,t)=>e+Math.random()*(e-t),y=(e,t)=>e+Math.floor(Math.random()*(t-e+1)),K=e=>e[Math.floor(Math.random()*e.length)],w=(e,t)=>(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-2.5)*.5*t+e,V=e=>{for(let t=e.length-1;t>=1;t--){const s=y(0,t);[e[s],e[t]]=[e[t],e[s]]}},v=class{constructor(t,s){l(this,"x");l(this,"y");this.x=t,this.y=s}addMut({x:t,y:s}){return this.x+=t,this.y+=s,this}add({x:t,y:s}){return c(this.x+t,this.y+s)}subMut({x:t,y:s}){return this.x-=t,this.y-=s,this}sub({x:t,y:s}){return c(this.x-t,this.y-s)}timesMut(t){return this.x*=t,this.y*=t,this}times(t){return c(this.x*t,this.y*t)}divMut(t){return this.x/=t,this.y/=t,this}div(t){return c(this.x/t,this.y/t)}distSq({x:t,y:s}){return(t-this.x)**2+(s-this.y)**2}dist(t){return Math.sqrt(this.distSq(t))}length(){return Math.sqrt(this.lengthSq())}lengthSq(){return this.x**2+this.y**2}normalize(){return this.div(this.length())}normalizeMut(){return this.divMut(this.length()),this}copy({x:t,y:s}){return this.x=t,this.y=s,this}set(t,s){return this.x=t,this.y=s,this}clone(){return c(this.x,this.y)}dot({x:t,y:s}){return this.x*t+this.y*s}reflectMut(t){const s=2*this.dot(t);return this.x-=t.x*s,this.y-=t.y*s,this}reflect(t){return this.sub(t.times(2*this.dot(t)))}limitMut(t){return this.lengthSq()>t*t?this.normalizeMut().timesMut(t):this}limit(t){return this.lengthSq()>t*t?this.normalize().timesMut(t):this.clone()}};let f=v;l(f,"v1",new v(0,0)),l(f,"v2",new v(0,0)),l(f,"v3",new v(0,0));const c=(e,t)=>new f(e,t),d=class{constructor(){l(this,"tiles");this.tiles=new Map}setStaticRegion(t,s,o){for(const n of this.visibleTiles(t,s,o))n.static=!0}removeUnused(){const t=Date.now(),s=d.UNUSED_THRESHOLD*Math.exp(-(this.tiles.size-d.MAX_CACHE_SIZE)/90);for(const[o,n]of this.tiles.entries())!n.static&&t-n.lastUsed>s&&this.tiles.delete(o)}createTile(t,s=!1){this.tiles.size>=d.MAX_CACHE_SIZE&&this.removeUnused();const o=[],n=w(20,10);for(let r=0;r<n;r++)o.push({center:c(y(0,d.TILE_SIZE),y(0,d.TILE_SIZE)).addMut(t),radius:Math.floor(w(3,1))});return{stars:o,position:t,lastUsed:Date.now(),static:s}}tileAt(t,s){const o=`${t}:${s}`;if(this.tiles.has(o)){const r=this.tiles.get(o);return r.lastUsed=Date.now(),r}const n=this.createTile(c(t*d.TILE_SIZE,s*d.TILE_SIZE));return this.tiles.set(o,n),n}*visibleTiles(t,s,o){for(let n=t.x-d.TILE_SIZE;n<=t.x+s;n+=d.TILE_SIZE)for(let r=t.y-d.TILE_SIZE;r<=t.y+o;r+=d.TILE_SIZE)yield this.tileAt(Math.floor(n/d.TILE_SIZE),Math.floor(r/d.TILE_SIZE))}clear(){this.tiles.clear()}};let b=d;l(b,"TILE_SIZE",1024),l(b,"MAX_CACHE_SIZE",200),l(b,"UNUSED_THRESHOLD",10*1e3);const C=(e,t)=>e.center.distSq(t.center)<=(e.radius+t.radius+q)**2,P=(e,t,s,o)=>({center:c(y(0,s),y(0,o)),radius:y(e,t)}),Y=(e,t,s,o,n,r)=>{const i={retry:()=>{const a=P(t,s,o,n);return e.some(u=>C(a,u))?i.retry():a},shrink:()=>{const a=P(t,s,o,n);for(;e.some(u=>C(a,u))&&a.radius>=t;)a.radius-=1;return a.radius<t?i.shrink():a},exact:()=>{const a=c(y(0,o),y(0,n)),u=Math.min(y(t,s),...e.map(h=>h.center.dist(a)-h.radius));return u<t+q?i.exact():{center:a,radius:u}}};return i[r]()},$=(e,t,s,o,n,r)=>{const i=[];for(let a=0;a<e;a++)i.push(Y(i,t,s,o,n,r));return i},J=()=>{const e=K(Q);V(e);let t=0;return()=>e[t++%e.length]},Q=[["#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"],["#e63946","#f1faee","#a8dadc","#457b9d","#1d3557"],["#006d77","#83c5be","#edf6f9","#ffddd2","#e29578"],["#ef476f","#ffd166","#06d6a0","#118ab2","#073b4c"],["#f72585","#7209b7","#3a0ca3","#4361ee","#4cc9f0"],["#dec9e9","#dac3e8","#d2b7e5","#c19ee0","#b185db"],["#a06cd5","#9163cb","#815ac0","#7251b5","#6247aa"],["#f79256","#fbd1a2","#7dcfb6","#00b2ca","#1d4e89"],["#1a535c","#4ecdc4","#f7fff7","#ff6b6b","#ffe66d"],["#eddcd2","#fff1e6","#fde2e4","#fad2e1","#c5dedd"],["#dbe7e4","#f0efeb","#d6e2e9","#bcd4e6","#99c1de"],["#27187e","#758bfd","#aeb8fe","#f1f2f6","#ff8600"],["#ffbc42","#d81159","#8f2d56","#218380","#73d2de"],["#f8ffe5","#06d6a0","#1b9aaa","#ef476f","#ffc43d"],["#ddfff7","#93e1d8","#ffa69e","#aa4465","#861657"],["#826aed","#c879ff","#ffb7ff","#3bf4fb","#caff8a"],["#ff00ea","#b300e8","#880dff","#3500e8","#000bff"],["#034732","#008148","#c6c013","#ef8a17","#ef2917"],["#000000","#e4d6a7","#e9b44c","#9b2915","#50a2a7"],["#114b5f","#028090","#e4fde1","#456990","#f45b69"],["#ffffff","#84dcc6","#a5ffd6","#ffa69e","#ff686b"],["#602437","#ff8700","#ffd300","#deff0a","#a1ff0a"],["##0aff99","#0aefff","#147df5","#580aff","#be0aff"],["#90f1ef","#ffd6e0","#ffef9f","#c1fba4","#7bf1a8"],["#5465ff","#788bff","#9bb1ff","#bfd7ff","#e2fdff"],["#ffc2d4","#ff9ebb","#ff7aa2","#e05780","#b9375e","#8a2846","#602437"],["#fffae5","#fff6cc","#fff2b2","#ffee99","#ffe97f"],["#ffe566","#ffe14c","#ffdd32","#ffd819","#ffd400"],["#faa916","#fbfffe","#6d676e","#96031a","#deff0a"],["#d88c9a","#f2d0a9","#f1e3d3","#99c1b9","#8e7dbe"],["#d9f4c7","#f8fa90","#f4ef88","#ac9969","#9dcdc0"],["#be0e57","#3626a7","#657ed4","#ff331f","#fbfbff"],["#1c77c3","#39a9db","#40bcd8","#f39237","#d63230"],["#00568f","#a30000","#ff7700","#efd28d","#00afb5"],["#247ba0","#70c1b3","#b2dbbf","#f3ffbd","#ff1654"],["#8ab1d0","#4c6a94","#e6aace","#f0f4ef","#91a550"],["#0e7c7b","#17bebb","#d4f4dd","#d62246","#933979"],["#6aa0a0","#ffffff","#ffd5c2","#f28f3b","#c8553d"],["#8b8bd0","#764ad3","#402bca","#7180b9","#c4e9ce"],["#24a810","#abff4f","#08bdbd","#f21b3f","#ff9914"],["#6f1d1b","#bb9457","#f5f5f5","#99582a","#ffe6a7"],["#fe4a49","#2ab7ca","#fed766","#858599","#f4f4f8"],["#de6b48","#e5b181","#f4b9b2","#daedbd","#7dbbc3"],["#eef4d4","#daefb3","#ea9e8d","#d64550","#649089"],["#f7b267","#f79d65","#f4845f","#f27059","#f25c54"],["#086788","#07a0c3","#f0c808","#fff1d0","#dd1c1a"],["#b5ffe1","#93e5ab","#65b891","#4e878c","#00A37A"],["#c1c1c1","#2c4251","#d16666","#b6c649","#ffffff"]],m=6,q=m*4,O=e=>e**2*2700,N=(e,t,s=m)=>{const o=j(0,2*Math.PI);return e.add(c(Math.cos(o),Math.sin(o)).times(t+s))},tt=(e=10)=>t=>{const s=J();$(e,40,90,window.innerWidth,window.innerHeight,"retry").forEach(({center:o,radius:n},r)=>{const i=t.addEntity([{type:"body",position:o,mass:O(n)},{type:"shape",kind:"circle",color:s(),radius:n},{type:"attractor"}]);r===e-1&&i.add({type:"target",target:N(o,n,0)})})},et=(e=1)=>t=>{const s=t.query(x),[o,{position:n},{radius:r}]=s.find(([i,a,u,h])=>!t.hasComponent(h,"target")||s.length===1);for(let i=0;i<e;i++)t.addEntity([{type:"body",position:N(n,r),mass:O(m)},{type:"movement",acceleration:c(0,0),velocity:c(0,0),prevPosition:c(1/0,1/0)},{type:"shape",kind:"circle",radius:m,color:"rgb(255, 255, 255)"}])},st=e=>{const{canvas:t,action:s}=e.resources;t.addEventListener("pointerdown",n=>{s.start.set(n.clientX,n.clientY)}),t.addEventListener("pointermove",n=>{s.start.x<1/0&&s.end.set(n.clientX,n.clientY)});const o=["movement"];t.addEventListener("pointerup",()=>{const n=f.v1.copy(s.start).subMut(s.end).timesMut(500).limitMut(6e4);if(!isNaN(n.x)&&!isNaN(n.y))for(const[{acceleration:r},i]of e.queryIter(o))e.hasComponent(i,"active")||e.addComponent(i,{type:"active"}),r.addMut(n);s.start.set(1/0,1/0),s.end.set(1/0,1/0)}),window.addEventListener("keydown",n=>{n.key===" "&&(e.resources.game.deltaT=1/20)}),window.addEventListener("keyup",n=>{n.key===" "&&(e.resources.game.deltaT=1/60)})},Z=2*Math.PI,D=m*2,R="rgb(9, 7, 56)",nt=e=>{const{canvas:t,context:s}=e.resources;s.clearRect(0,0,e.resources.canvas.width,t.height),s.fillStyle=R,s.fillRect(0,0,t.width,t.height)},p=(e,t,s,o)=>{e.beginPath(),e.fillStyle=o,e.arc(t.x,t.y,s,0,Z),e.closePath(),e.fill()},ot=e=>{for(const[t,{position:s},o]of e.queryIter(x))o.kind==="circle"&&p(e.resources.context,f.v1.copy(s).addMut(e.resources.game.camera.offset),o.radius,o.color)},rt=e=>{for(const[t,{position:s},o,n]of e.queryIter(G))if(o.kind==="circle"){const r=f.v1.copy(s).addMut(e.resources.game.camera.offset),i=e.hasComponent(n,"active")?o.color:"lightgrey";p(e.resources.context,r,o.radius,i)}},it=e=>{const{context:t,action:s}=e.resources,o=e.resources.game.camera.offset;if(s.start.x<1/0){const n=f.v1.copy(s.start).subMut(s.end).timesMut(.5).limitMut(s.maxLength);for(const[r,{position:i}]of e.queryIter(A))t.beginPath(),t.strokeStyle="rgb(255, 255, 255)",t.moveTo(i.x+o.x,i.y+o.y),t.lineTo(i.x+o.x+n.x,i.y+o.y+n.y),t.closePath(),t.stroke()}},at=e=>{const{context:t}=e.resources,s=e.resources.game.camera.offset;for(const[{target:o}]of e.queryIter(X))t.beginPath(),t.fillStyle=R,t.arc(o.x+s.x,o.y+s.y,D,0,Z),t.closePath(),t.fill()},ft="rgb(234, 231, 163)",ct=e=>{const{context:t,stars:s}=e.resources,o=e.resources.game.camera.offset;for(const n of s.visibleTiles(o,t.canvas.width,t.canvas.height))for(const{center:r,radius:i}of n.stars){const a=o.x-r.x+t.canvas.width-b.TILE_SIZE,u=o.y-r.y+t.canvas.height-b.TILE_SIZE;p(t,f.v1.set(a,u),i,ft)}},dt=E(nt,ct,ot,at,rt,it),lt=2.4,ut=.02,ht=e=>{const t=e.resources.game.deltaT;for(const[s,{velocity:o,acceleration:n},{position:r,mass:i}]of e.queryIter(W)){for(const[a,{position:u,mass:h}]of e.queryIter(F)){const M=f.v1.copy(u).subMut(r),I=lt*(i*h/M.lengthSq()),g=M.normalizeMut().timesMut(I);n.addMut(g.divMut(i))}o.addMut(f.v1.copy(n).timesMut(t)),r.addMut(f.v1.copy(o).timesMut(t)),n.set(0,0)}},yt=e=>{const t=e.queryIter(z);for(const[s,{velocity:o,prevPosition:n},{position:r},i,a]of t)for(const[u,{position:h},M,I]of e.queryIter(x)){const g=i.radius+M.radius;if(r.distSq(h)<=g**2){const L=f.v1.copy(r).subMut(h).normalizeMut(),_=f.v2.copy(h).addMut(f.v3.copy(L).timesMut(g));o.subMut(f.v3.copy(o).timesMut(ut)),o.reflectMut(L).timesMut(.76);const S=e.getComponent(I,"target");S&&S.target.distSq(r)<=D**2&&(_.copy(S.target),e.removeComponent(a,"active"),e.resources.game.nextLevel()),r.copy(_),n.distSq(r)<.3&&e.removeComponent(a,"active"),n.copy(r);break}}},bt=E(ht,yt),mt=100,vt=e=>e.next().value,Mt=e=>{const t=e.resources.game.camera,s=vt(e.queryIter(A));if(s){const[o,{position:n}]=s,{canvas:r}=e.resources,i=f.v1.set(0,0);n.x<0&&(i.x=-n.x),n.x>r.width/2&&(i.x=r.width/2-n.x),n.y<0&&(i.y=-n.y),n.y>r.height/2&&(i.y=r.height/2-n.y),(i.x!==0||i.y!==0)&&i.addMut(f.v2.set(r.width/2,r.height/2).subMut(n).normalizeMut().timesMut(mt)),t.targetOffset.copy(i),t.offset.addMut(f.v3.copy(t.targetOffset).subMut(t.offset).timesMut(.05))}};class gt{constructor(){l(this,"app");l(this,"canvas");l(this,"camera");l(this,"deltaT",1/60);const t=document.createElement("canvas");this.canvas=t,t.width=window.innerWidth,t.height=window.innerHeight;const s=t.getContext("2d"),o=window.devicePixelRatio;if(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px",t.width=Math.floor(window.innerWidth*o),t.height=Math.floor(window.innerHeight*o),s===null)throw"could not get canvas 2d context";s.scale(o,o),this.camera={offset:c(0,0),targetOffset:c(0,0)},this.app=U({canvas:t,context:s,action:{start:c(1/0,1/0),end:c(1/0,1/0),maxLength:150},game:this,stars:new b}).addStartupSystem(st).addSystem(bt).addSystem(dt).addSystem(Mt),this.nextLevel(!0)}nextLevel(t=!1){const s=E(tt(Math.round(w(4,2))),et(1));setTimeout(()=>{this.app.clearEntities(),this.app.resources.stars.clear(),this.app.resources.stars.setStaticRegion(f.v1.set(0,0),this.canvas.width,this.canvas.height),s(this.app)},t?0:1e3)}run(){this.app.run()}}const T=new gt;T.run();document.body.appendChild(T.canvas);window.game=T;
