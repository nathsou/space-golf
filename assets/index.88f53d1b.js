var A=Object.defineProperty;var z=(e,t,s)=>t in e?A(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var y=(e,t,s)=>(z(e,typeof t!="symbol"?t+"":t,s),s);import{c as p,a as B}from"./vendor.594abaaa.js";const F=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}};F();class D{constructor(t,s){y(this,"x");y(this,"y");this.x=t,this.y=s}addMut({x:t,y:s}){return this.x+=t,this.y+=s,this}add({x:t,y:s}){return c(this.x+t,this.y+s)}subMut({x:t,y:s}){return this.x-=t,this.y-=s,this}sub({x:t,y:s}){return c(this.x-t,this.y-s)}timesMut(t){return this.x*=t,this.y*=t,this}times(t){return c(this.x*t,this.y*t)}divMut(t){return this.x/=t,this.y/=t,this}div(t){return c(this.x/t,this.y/t)}distSq({x:t,y:s}){return(t-this.x)**2+(s-this.y)**2}dist(t){return Math.sqrt(this.distSq(t))}length(){return Math.sqrt(this.lengthSq())}lengthSq(){return this.x**2+this.y**2}normalize(){return this.div(this.length())}normalizeMut(){return this.divMut(this.length()),this}copy({x:t,y:s}){return this.x=t,this.y=s,this}set(t,s){return this.x=t,this.y=s,this}clone(){return c(this.x,this.y)}dot({x:t,y:s}){return this.x*t+this.y*s}reflectMut(t){const s=2*this.dot(t);return this.x-=t.x*s,this.y-=t.y*s,this}reflect(t){return this.sub(t.times(2*this.dot(t)))}limitMut(t){return this.lengthSq()>t*t?this.normalizeMut().timesMut(t):this}limit(t){return this.lengthSq()>t*t?this.normalize().timesMut(t):this.clone()}}const c=(e,t)=>new D(e,t),d={v1:c(0,0),v2:c(0,0),v3:c(0,0),v4:c(0,0)},G=(e,t)=>e+Math.random()*(e-t),l=(e,t)=>e+Math.floor(Math.random()*(t-e+1)),R=e=>e[Math.floor(Math.random()*e.length)],W=(e,t)=>(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-2.5)*.5*e+t,q=(e,t)=>e.center.distSq(t.center)<=(e.radius+t.radius+T)**2,P=(e,t,s,o)=>({center:c(l(0,s),l(0,o)),radius:l(e,t)}),U=(e,t,s,o,n,r)=>{const i={retry:()=>{const a=P(t,s,o,n);return e.some(u=>q(a,u))?i.retry():a},shrink:()=>{const a=P(t,s,o,n);for(;e.some(u=>q(a,u))&&a.radius>=t;)a.radius-=1;return a.radius<t?i.shrink():a},exact:()=>{const a=c(l(0,o),l(0,n)),u=Math.min(l(t,s),...e.map(m=>m.center.dist(a)-m.radius));return u<t+T?i.exact():{center:a,radius:u}}};return i[r]()},$=(e,t,s,o,n,r)=>{const i=[];for(let a=0;a<e;a++)i.push(U(i,t,s,o,n,r));return i},E=(e,t,s)=>({r:e,g:t,b:s}),H=()=>E(l(0,255),l(0,255),l(0,255)),K=({r:e,g:t,b:s})=>`rgb(${e}, ${t}, ${s})`,f=6,T=f*4,C=e=>e**2*7e8,L=(e,t,s=f)=>{const o=G(0,2*Math.PI);return e.add(c(Math.cos(o),Math.sin(o)).times(t+s))},X=(e=10)=>t=>{$(e,40,90,window.innerWidth,window.innerHeight,"retry").forEach(({center:s,radius:o},n)=>{const r=t.addEntity([{type:"body",position:s,mass:C(o)},{type:"shape",kind:"circle",color:H(),radius:o},{type:"attractor"}]);n===e-1&&r.add({type:"target",target:L(s,o,0)})})},Y=(e=1)=>t=>{const s=t.query("body","shape","attractor");for(let o=0;o<e;o++){const[{position:n},{radius:r}]=R(s);t.addEntity([{type:"body",position:L(n,r),mass:C(f)},{type:"movement",acceleration:c(0,0),velocity:c(0,0),prevPosition:c(1/0,1/0)},{type:"shape",kind:"circle",radius:f,color:E(255,255,255)}])}},j=e=>{const{canvas:t,action:s}=e.resources;t.addEventListener("pointerdown",o=>{s.start.set(o.clientX,o.clientY)}),t.addEventListener("pointermove",o=>{s.start.x<1/0&&s.end.set(o.clientX,o.clientY)}),t.addEventListener("pointerup",()=>{const o=d.v1.copy(s.start).subMut(s.end).timesMut(500).limitMut(1e5*.6);if(!isNaN(o.x)&&!isNaN(o.y))for(const[{acceleration:n},r]of e.queryIter("movement"))e.hasComponent(r,"active")||e.addComponent(r,{type:"active"}),n.addMut(o);s.start.set(1/0,1/0),s.end.set(1/0,1/0)}),window.addEventListener("keydown",o=>{o.key===" "&&(e.resources.game.deltaT=1/20)}),window.addEventListener("keyup",o=>{o.key===" "&&(e.resources.game.deltaT=1/60)})},N=2*Math.PI,_=f*2,O="rgb(9, 7, 56)",V=e=>{const{canvas:t,context:s}=e.resources;s.clearRect(0,0,e.resources.canvas.width,t.height),s.fillStyle=O,s.fillRect(0,0,t.width,t.height)},k=(e,t,s,o)=>{e.beginPath(),e.fillStyle=K(o),e.arc(t.x,t.y,s,0,N),e.closePath(),e.fill()},J=e=>{for(const[{position:t},s]of e.queryIter("body","shape","attractor"))s.kind==="circle"&&k(e.resources.context,d.v1.copy(t).addMut(e.resources.game.camera.offset),s.radius,s.color)},Q=e=>{for(const[{position:t},s]of e.queryIter("body","shape","movement"))if(s.kind==="circle"){const o=d.v1.copy(t).addMut(e.resources.game.camera.offset);k(e.resources.context,o,s.radius,s.color)}},Z=e=>{const{context:t,action:s}=e.resources,o=e.resources.game.camera.offset;if(s.start.x<1/0){const n=d.v1.copy(s.start).subMut(s.end).timesMut(.5).limitMut(s.maxLength);for(const[r,{position:i}]of e.queryIter("movement","body"))t.beginPath(),t.strokeStyle="rgb(255, 255, 255)",t.moveTo(i.x+o.x,i.y+o.y),t.lineTo(i.x+o.x+n.x,i.y+o.y+n.y),t.closePath(),t.stroke()}},tt=e=>{const{context:t}=e.resources,s=e.resources.game.camera.offset;for(const[{target:o}]of e.queryIter("target"))t.beginPath(),t.fillStyle=O,t.arc(o.x+s.x,o.y+s.y,_,0,N),t.closePath(),t.fill()},et=p(V,J,tt,Q,Z),st=(e,t,s,o)=>{const n=d.v1.copy(e).subMut(s),r=1e-5*(o*t/n.lengthSq());return n.normalizeMut().timesMut(r)},ot=e=>{const t=e.queryIter("active","movement","body"),s=e.query("attractor","body"),o=e.resources.game.deltaT;for(const[n,{velocity:r,acceleration:i},{position:a,mass:u}]of t){for(const[m,{position:h,mass:v}]of s){const M=st(h,v,a,u);i.addMut(M.divMut(u))}r.addMut(d.v1.copy(i).timesMut(o)),a.addMut(d.v1.copy(r).timesMut(o)),i.set(0,0)}},nt=e=>{const t=e.queryIter("active","movement","body","shape"),s=e.query("attractor","body","shape");for(const[o,{velocity:n,prevPosition:r},{position:i},a,u]of t)for(const[m,{position:h},v,M]of s){const b=a.radius+v.radius;if(i.distSq(h)<=b**2){const w=d.v1.copy(i).subMut(h).normalizeMut(),I=d.v2.copy(h).addMut(d.v3.copy(w).timesMut(b));n.reflectMut(w).timesMut(.8);const g=e.getComponent(M,"target");g&&g.target.distSq(i)<=_**2&&(I.copy(g.target),e.resources.game.nextLevel()),i.copy(I),r.distSq(i)<.3&&e.removeComponent(u,"active");break}}},x=p(ot,nt),rt=100,it=e=>{const t=e.resources.game.camera,s=e.query("movement","body");if(s.length===1){const[o,{position:n}]=s[0],{canvas:r}=e.resources,i=d.v1.set(0,0);n.x<0&&(i.x=-n.x),n.x>r.width&&(i.x=-(n.x-r.width)),n.y<0&&(i.y=-n.y),n.y>r.height&&(i.y=-(n.y-r.height)),(i.x!==0||i.y!==0)&&i.addMut(d.v2.set(r.width/2,r.height/2).subMut(n).normalizeMut().timesMut(rt)),t.targetOffset.copy(i),t.offset.addMut(d.v3.copy(t.targetOffset).subMut(t.offset).timesMut(.06))}};class at{constructor(){y(this,"app");y(this,"canvas");y(this,"camera");y(this,"deltaT",1/60);const t=document.createElement("canvas");this.canvas=t,t.width=window.innerWidth,t.height=window.innerHeight;const s=t.getContext("2d");if(s===null)throw"could not get canvas 2d context";this.camera={offset:c(0,0),targetOffset:c(0,0)},this.app=B({canvas:t,context:s,action:{start:c(1/0,1/0),end:c(1/0,1/0),maxLength:150},game:this}).addStartupSystem(j).addSystem(x).addSystem(et).addSystem(it),this.nextLevel(!0)}nextLevel(t=!1){const s=p(X(Math.round(W(2,4))),Y(1));this.app.removeSystem(x),setTimeout(()=>{for(const o of this.app.getEntities())this.app.removeEntity(o);s(this.app),this.app.addSystem(x)},t?0:1e3)}run(){this.app.run()}}const S=new at;S.run();document.body.appendChild(S.canvas);window.game=S;
