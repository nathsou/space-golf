var B=Object.defineProperty;var R=(s,t,e)=>t in s?B(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var y=(s,t,e)=>(R(s,typeof t!="symbol"?t+"":t,e),e);import{c as S,a as F}from"./vendor.be7e0c02.js";const $=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerpolicy&&(n.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?n.credentials="include":o.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}};$();class D{constructor(t,e){y(this,"x");y(this,"y");this.x=t,this.y=e}addMut({x:t,y:e}){return this.x+=t,this.y+=e,this}add({x:t,y:e}){return a(this.x+t,this.y+e)}subMut({x:t,y:e}){return this.x-=t,this.y-=e,this}sub({x:t,y:e}){return a(this.x-t,this.y-e)}timesMut(t){return this.x*=t,this.y*=t,this}times(t){return a(this.x*t,this.y*t)}divMut(t){return this.x/=t,this.y/=t,this}div(t){return a(this.x/t,this.y/t)}distSq({x:t,y:e}){return(t-this.x)**2+(e-this.y)**2}dist(t){return Math.sqrt(this.distSq(t))}length(){return Math.sqrt(this.lengthSq())}lengthSq(){return this.x**2+this.y**2}normalize(){return this.div(this.length())}normalizeMut(){return this.divMut(this.length()),this}copy({x:t,y:e}){return this.x=t,this.y=e,this}set(t,e){return this.x=t,this.y=e,this}clone(){return a(this.x,this.y)}dot({x:t,y:e}){return this.x*t+this.y*e}reflectMut(t){const e=2*this.dot(t);return this.x-=t.x*e,this.y-=t.y*e,this}reflect(t){return this.sub(t.times(2*this.dot(t)))}limitMut(t){return this.lengthSq()>t*t?this.normalizeMut().timesMut(t):this}limit(t){return this.lengthSq()>t*t?this.normalize().timesMut(t):this.clone()}}const a=(s,t)=>new D(s,t),l={v1:a(0,0),v2:a(0,0),v3:a(0,0)},G=(s,t)=>s+Math.random()*(s-t),h=(s,t)=>s+Math.floor(Math.random()*(t-s+1)),p=(s,t)=>(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-2.5)*.5*t+s,u=class{constructor(){y(this,"tiles");this.tiles=new Map}createTile(t){const e=[],r=p(10,4);for(let o=0;o<r;o++)e.push({center:a(h(0,u.TILE_SIZE),h(0,u.TILE_SIZE)).addMut(t),radius:Math.floor(p(3,1))});return{stars:e,position:t}}tileAt(t,e){const r=`${t}:${e}`;if(this.tiles.has(r))return this.tiles.get(r);const o=this.createTile(a(t*u.TILE_SIZE,e*u.TILE_SIZE));return this.tiles.set(r,o),o}*visibleTiles(t,e,r){for(let o=t.x-u.TILE_SIZE;o<=t.x+e;o+=u.TILE_SIZE)for(let n=t.y-u.TILE_SIZE;n<=t.y+r;n+=u.TILE_SIZE)yield this.tileAt(Math.floor(o/u.TILE_SIZE),Math.floor(n/u.TILE_SIZE))}clear(){this.tiles.clear()}};let m=u;y(m,"TILE_SIZE",512);const q=(s,t,e)=>({r:s,g:t,b:e}),W=()=>q(h(0,255),h(0,255),h(0,255)),P=({r:s,g:t,b:e})=>`rgb(${s}, ${t}, ${e})`,_=(s,t)=>s.center.distSq(t.center)<=(s.radius+t.radius+O)**2,C=(s,t,e,r)=>({center:a(h(0,e),h(0,r)),radius:h(s,t)}),U=(s,t,e,r,o,n)=>{const i={retry:()=>{const c=C(t,e,r,o);return s.some(d=>_(c,d))?i.retry():c},shrink:()=>{const c=C(t,e,r,o);for(;s.some(d=>_(c,d))&&c.radius>=t;)c.radius-=1;return c.radius<t?i.shrink():c},exact:()=>{const c=a(h(0,r),h(0,o)),d=Math.min(h(t,e),...s.map(f=>f.center.dist(c)-f.radius));return d<t+O?i.exact():{center:c,radius:d}}};return i[n]()},H=(s,t,e,r,o,n)=>{const i=[];for(let c=0;c<s;c++)i.push(U(i,t,e,r,o,n));return i},v=6,O=v*4,N=s=>s**2*7e8,A=(s,t,e=v)=>{const r=G(0,2*Math.PI);return s.add(a(Math.cos(r),Math.sin(r)).times(t+e))},K=(s=10)=>t=>{H(s,40,90,window.innerWidth,window.innerHeight,"retry").forEach(({center:e,radius:r},o)=>{const n=t.addEntity([{type:"body",position:e,mass:N(r)},{type:"shape",kind:"circle",color:W(),radius:r},{type:"attractor"}]);o===s-1&&n.add({type:"target",target:A(e,r,0)})})},X=(s=1)=>t=>{const e=t.query("body","shape","attractor"),[{position:r},{radius:o}]=e.find(([n,i,c,d])=>!t.hasComponent(d,"target")||e.length===1);for(let n=0;n<s;n++)t.addEntity([{type:"body",position:A(r,o),mass:N(v)},{type:"movement",acceleration:a(0,0),velocity:a(0,0),prevPosition:a(1/0,1/0)},{type:"shape",kind:"circle",radius:v,color:q(255,255,255)}])},Y=s=>{const{canvas:t,action:e}=s.resources;t.addEventListener("pointerdown",r=>{e.start.set(r.clientX,r.clientY)}),t.addEventListener("pointermove",r=>{e.start.x<1/0&&e.end.set(r.clientX,r.clientY)}),t.addEventListener("pointerup",()=>{const r=l.v1.copy(e.start).subMut(e.end).timesMut(500).limitMut(1e5*.6);if(!isNaN(r.x)&&!isNaN(r.y))for(const[{acceleration:o},n]of s.queryIter("movement"))s.hasComponent(n,"active")||s.addComponent(n,{type:"active"}),o.addMut(r);e.start.set(1/0,1/0),e.end.set(1/0,1/0)}),window.addEventListener("keydown",r=>{r.key===" "&&(s.resources.game.deltaT=1/20)}),window.addEventListener("keyup",r=>{r.key===" "&&(s.resources.game.deltaT=1/60)})},Z=2*Math.PI,k=v*2,z="rgb(9, 7, 56)",j=s=>{const{canvas:t,context:e}=s.resources;e.clearRect(0,0,s.resources.canvas.width,t.height),e.fillStyle=z,e.fillRect(0,0,t.width,t.height)},x=(s,t,e,r)=>{s.beginPath(),s.fillStyle=r,s.arc(t.x,t.y,e,0,Z),s.closePath(),s.fill()},V=s=>{for(const[{position:t},e]of s.queryIter("body","shape","attractor"))e.kind==="circle"&&x(s.resources.context,l.v1.copy(t).addMut(s.resources.game.camera.offset),e.radius,P(e.color))},J=s=>{for(const[{position:t},e]of s.queryIter("body","shape","movement"))if(e.kind==="circle"){const r=l.v1.copy(t).addMut(s.resources.game.camera.offset);x(s.resources.context,r,e.radius,P(e.color))}},Q=s=>{const{context:t,action:e}=s.resources,r=s.resources.game.camera.offset;if(e.start.x<1/0){const o=l.v1.copy(e.start).subMut(e.end).timesMut(.5).limitMut(e.maxLength);for(const[n,{position:i}]of s.queryIter("movement","body"))t.beginPath(),t.strokeStyle="rgb(255, 255, 255)",t.moveTo(i.x+r.x,i.y+r.y),t.lineTo(i.x+r.x+o.x,i.y+r.y+o.y),t.closePath(),t.stroke()}},tt=s=>{const{context:t}=s.resources,e=s.resources.game.camera.offset;for(const[{target:r}]of s.queryIter("target"))t.beginPath(),t.fillStyle=z,t.arc(r.x+e.x,r.y+e.y,k,0,Z),t.closePath(),t.fill()},et="rgb(234, 231, 163)",st=s=>{const{context:t,stars:e}=s.resources,r=s.resources.game.camera.offset;for(const o of e.visibleTiles(r,t.canvas.width,t.canvas.height))for(const{center:n,radius:i}of o.stars){const c=r.x-n.x+t.canvas.width-m.TILE_SIZE,d=r.y-n.y+t.canvas.height-m.TILE_SIZE;x(t,l.v1.set(c,d),i,et)}},rt=S(j,st,V,tt,J,Q),ot=(s,t,e,r)=>{const o=l.v1.copy(s).subMut(e),n=1e-5*(r*t/o.lengthSq());return o.normalizeMut().timesMut(n)},nt=s=>{const t=s.queryIter("active","movement","body"),e=s.resources.game.deltaT;for(const[r,{velocity:o,acceleration:n},{position:i,mass:c}]of t){for(const[d,{position:f,mass:g}]of s.queryIter("attractor","body")){const M=ot(f,g,i,c);n.addMut(M.divMut(c))}o.addMut(l.v1.copy(n).timesMut(e)),i.addMut(l.v1.copy(o).timesMut(e)),n.set(0,0)}},it=s=>{const t=s.queryIter("active","movement","body","shape");for(const[e,{velocity:r,prevPosition:o},{position:n},i,c]of t)for(const[d,{position:f},g,M]of s.queryIter("attractor","body","shape")){const w=i.radius+g.radius;if(n.distSq(f)<=w**2){const T=l.v1.copy(n).subMut(f).normalizeMut(),L=l.v2.copy(f).addMut(l.v3.copy(T).timesMut(w));r.reflectMut(T).timesMut(.8);const I=s.getComponent(M,"target");I&&I.target.distSq(n)<=k**2&&(L.copy(I.target),s.resources.game.nextLevel()),n.copy(L),o.distSq(n)<.3&&s.removeComponent(c,"active");break}}},b=S(nt,it),ct=100,at=s=>{const t=s.resources.game.camera,e=s.query("movement","body");if(e.length===1){const[r,{position:o}]=e[0],{canvas:n}=s.resources,i=l.v1.set(0,0);o.x<0&&(i.x=-o.x),o.x>n.width&&(i.x=-(o.x-n.width)),o.y<0&&(i.y=-o.y),o.y>n.height&&(i.y=-(o.y-n.height)),(i.x!==0||i.y!==0)&&i.addMut(l.v2.set(n.width/2,n.height/2).subMut(o).normalizeMut().timesMut(ct)),t.targetOffset.copy(i),t.offset.addMut(l.v3.copy(t.targetOffset).subMut(t.offset).timesMut(.06))}};class lt{constructor(){y(this,"app");y(this,"canvas");y(this,"camera");y(this,"deltaT",1/60);const t=document.createElement("canvas");this.canvas=t,t.width=window.innerWidth,t.height=window.innerHeight;const e=t.getContext("2d");if(e===null)throw"could not get canvas 2d context";this.camera={offset:a(0,0),targetOffset:a(0,0)},this.app=F({canvas:t,context:e,action:{start:a(1/0,1/0),end:a(1/0,1/0),maxLength:150},game:this,stars:new m}).addStartupSystem(Y).addSystem(b).addSystem(rt).addSystem(at),this.nextLevel(!0)}nextLevel(t=!1){const e=S(K(Math.round(p(4,2))),X(1));this.app.removeSystem(b),setTimeout(()=>{this.app.clearEntities(),this.app.resources.stars.clear(),e(this.app),this.app.addSystem(b)},t?0:1e3)}run(){this.app.run()}}const E=new lt;E.run();document.body.appendChild(E.canvas);window.game=E;
