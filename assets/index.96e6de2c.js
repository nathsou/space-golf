var z=Object.defineProperty;var B=(s,t,e)=>t in s?z(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var l=(s,t,e)=>(B(s,typeof t!="symbol"?t+"":t,e),e);import{c as I,a as R}from"./vendor.be7e0c02.js";const W=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerpolicy&&(r.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?r.credentials="include":o.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=e(o);fetch(o.href,r)}};W();const F=(s,t)=>s+Math.random()*(s-t),h=(s,t)=>s+Math.floor(Math.random()*(t-s+1)),D=s=>s[Math.floor(Math.random()*s.length)],S=(s,t)=>(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-2.5)*.5*t+s,G=s=>{for(let t=s.length-1;t>=1;t--){const e=h(0,t);[s[e],s[t]]=[s[t],s[e]]}},v=class{constructor(t,e){l(this,"x");l(this,"y");this.x=t,this.y=e}addMut({x:t,y:e}){return this.x+=t,this.y+=e,this}add({x:t,y:e}){return c(this.x+t,this.y+e)}subMut({x:t,y:e}){return this.x-=t,this.y-=e,this}sub({x:t,y:e}){return c(this.x-t,this.y-e)}timesMut(t){return this.x*=t,this.y*=t,this}times(t){return c(this.x*t,this.y*t)}divMut(t){return this.x/=t,this.y/=t,this}div(t){return c(this.x/t,this.y/t)}distSq({x:t,y:e}){return(t-this.x)**2+(e-this.y)**2}dist(t){return Math.sqrt(this.distSq(t))}length(){return Math.sqrt(this.lengthSq())}lengthSq(){return this.x**2+this.y**2}normalize(){return this.div(this.length())}normalizeMut(){return this.divMut(this.length()),this}copy({x:t,y:e}){return this.x=t,this.y=e,this}set(t,e){return this.x=t,this.y=e,this}clone(){return c(this.x,this.y)}dot({x:t,y:e}){return this.x*t+this.y*e}reflectMut(t){const e=2*this.dot(t);return this.x-=t.x*e,this.y-=t.y*e,this}reflect(t){return this.sub(t.times(2*this.dot(t)))}limitMut(t){return this.lengthSq()>t*t?this.normalizeMut().timesMut(t):this}limit(t){return this.lengthSq()>t*t?this.normalize().timesMut(t):this.clone()}};let i=v;l(i,"v1",new v(0,0)),l(i,"v2",new v(0,0)),l(i,"v3",new v(0,0));const c=(s,t)=>new i(s,t),u=class{constructor(){l(this,"tiles");this.tiles=new Map}createTile(t){const e=[],n=S(10,4);for(let o=0;o<n;o++)e.push({center:c(h(0,u.TILE_SIZE),h(0,u.TILE_SIZE)).addMut(t),radius:Math.floor(S(3,1))});return{stars:e,position:t}}tileAt(t,e){const n=`${t}:${e}`;if(this.tiles.has(n))return this.tiles.get(n);const o=this.createTile(c(t*u.TILE_SIZE,e*u.TILE_SIZE));return this.tiles.set(n,o),o}*visibleTiles(t,e,n){for(let o=t.x-u.TILE_SIZE;o<=t.x+e;o+=u.TILE_SIZE)for(let r=t.y-u.TILE_SIZE;r<=t.y+n;r+=u.TILE_SIZE)yield this.tileAt(Math.floor(o/u.TILE_SIZE),Math.floor(r/u.TILE_SIZE))}clear(){this.tiles.clear()}};let b=u;l(b,"TILE_SIZE",512);const q=(s,t)=>s.center.distSq(t.center)<=(s.radius+t.radius+C)**2,_=(s,t,e,n)=>({center:c(h(0,e),h(0,n)),radius:h(s,t)}),H=(s,t,e,n,o,r)=>{const a={retry:()=>{const f=_(t,e,n,o);return s.some(d=>q(f,d))?a.retry():f},shrink:()=>{const f=_(t,e,n,o);for(;s.some(d=>q(f,d))&&f.radius>=t;)f.radius-=1;return f.radius<t?a.shrink():f},exact:()=>{const f=c(h(0,n),h(0,o)),d=Math.min(h(t,e),...s.map(y=>y.center.dist(f)-y.radius));return d<t+C?a.exact():{center:f,radius:d}}};return a[r]()},U=(s,t,e,n,o,r)=>{const a=[];for(let f=0;f<s;f++)a.push(H(a,t,e,n,o,r));return a},j=()=>{const s=D(K);G(s);let t=0;return()=>s[t++%s.length]},K=[["#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"],["#e63946","#f1faee","#a8dadc","#457b9d","#1d3557"],["#006d77","#83c5be","#edf6f9","#ffddd2","#e29578"],["#ef476f","#ffd166","#06d6a0","#118ab2","#073b4c"],["#f72585","#7209b7","#3a0ca3","#4361ee","#4cc9f0"],["#dec9e9","#dac3e8","#d2b7e5","#c19ee0","#b185db"],["#a06cd5","#9163cb","#815ac0","#7251b5","#6247aa"],["#f79256","#fbd1a2","#7dcfb6","#00b2ca","#1d4e89"],["#1a535c","#4ecdc4","#f7fff7","#ff6b6b","#ffe66d"],["#eddcd2","#fff1e6","#fde2e4","#fad2e1","#c5dedd"],["#dbe7e4","#f0efeb","#d6e2e9","#bcd4e6","#99c1de"],["#27187e","#758bfd","#aeb8fe","#f1f2f6","#ff8600"],["#ffbc42","#d81159","#8f2d56","#218380","#73d2de"],["#f8ffe5","#06d6a0","#1b9aaa","#ef476f","#ffc43d"],["#ddfff7","#93e1d8","#ffa69e","#aa4465","#861657"],["#826aed","#c879ff","#ffb7ff","#3bf4fb","#caff8a"],["#ff00ea","#b300e8","#880dff","#3500e8","#000bff"],["#034732","#008148","#c6c013","#ef8a17","#ef2917"],["#000000","#e4d6a7","#e9b44c","#9b2915","#50a2a7"],["#114b5f","#028090","#e4fde1","#456990","#f45b69"],["#ffffff","#84dcc6","#a5ffd6","#ffa69e","#ff686b"],["#602437","#ff8700","#ffd300","#deff0a","#a1ff0a"],["##0aff99","#0aefff","#147df5","#580aff","#be0aff"],["#90f1ef","#ffd6e0","#ffef9f","#c1fba4","#7bf1a8"],["#5465ff","#788bff","#9bb1ff","#bfd7ff","#e2fdff"],["#ffc2d4","#ff9ebb","#ff7aa2","#e05780","#b9375e","#8a2846","#602437"],["#fffae5","#fff6cc","#fff2b2","#ffee99","#ffe97f"],["#ffe566","#ffe14c","#ffdd32","#ffd819","#ffd400"],["#faa916","#fbfffe","#6d676e","#96031a","#deff0a"],["#d88c9a","#f2d0a9","#f1e3d3","#99c1b9","#8e7dbe"],["#d9f4c7","#f8fa90","#f4ef88","#ac9969","#9dcdc0"],["#be0e57","#3626a7","#657ed4","#ff331f","#fbfbff"],["#1c77c3","#39a9db","#40bcd8","#f39237","#d63230"],["#00568f","#a30000","#ff7700","#efd28d","#00afb5"],["#247ba0","#70c1b3","#b2dbbf","#f3ffbd","#ff1654"],["#8ab1d0","#4c6a94","#e6aace","#f0f4ef","#91a550"],["#0e7c7b","#17bebb","#d4f4dd","#d62246","#933979"],["#6aa0a0","#ffffff","#ffd5c2","#f28f3b","#c8553d"],["#8b8bd0","#764ad3","#402bca","#7180b9","#c4e9ce"],["#24a810","#abff4f","#08bdbd","#f21b3f","#ff9914"],["#6f1d1b","#bb9457","#f5f5f5","#99582a","#ffe6a7"],["#fe4a49","#2ab7ca","#fed766","#858599","#f4f4f8"],["#de6b48","#e5b181","#f4b9b2","#daedbd","#7dbbc3"],["#eef4d4","#daefb3","#ea9e8d","#d64550","#649089"],["#f7b267","#f79d65","#f4845f","#f27059","#f25c54"],["#086788","#07a0c3","#f0c808","#fff1d0","#dd1c1a"],["#b5ffe1","#93e5ab","#65b891","#4e878c","#00A37A"],["#c1c1c1","#2c4251","#d16666","#b6c649","#ffffff"]],m=6,C=m*4,A=s=>s**2*7e8,O=(s,t,e=m)=>{const n=F(0,2*Math.PI);return s.add(c(Math.cos(n),Math.sin(n)).times(t+e))},X=(s=10)=>t=>{const e=j();U(s,40,90,window.innerWidth,window.innerHeight,"retry").forEach(({center:n,radius:o},r)=>{const a=t.addEntity([{type:"body",position:n,mass:A(o)},{type:"shape",kind:"circle",color:e(),radius:o},{type:"attractor"}]);r===s-1&&a.add({type:"target",target:O(n,o,0)})})},Y=(s=1)=>t=>{const e=t.query("body","shape","attractor"),[{position:n},{radius:o}]=e.find(([r,a,f,d])=>!t.hasComponent(d,"target")||e.length===1);for(let r=0;r<s;r++)t.addEntity([{type:"body",position:O(n,o),mass:A(m)},{type:"movement",acceleration:c(0,0),velocity:c(0,0),prevPosition:c(1/0,1/0)},{type:"shape",kind:"circle",radius:m,color:"rgb(255, 255, 255)"}])},$=s=>{const{canvas:t,action:e}=s.resources;t.addEventListener("pointerdown",n=>{e.start.set(n.clientX,n.clientY)}),t.addEventListener("pointermove",n=>{e.start.x<1/0&&e.end.set(n.clientX,n.clientY)}),t.addEventListener("pointerup",()=>{const n=i.v1.copy(e.start).subMut(e.end).timesMut(500).limitMut(1e5*.6);if(!isNaN(n.x)&&!isNaN(n.y))for(const[{acceleration:o},r]of s.queryIter("movement"))s.hasComponent(r,"active")||s.addComponent(r,{type:"active"}),o.addMut(n);e.start.set(1/0,1/0),e.end.set(1/0,1/0)}),window.addEventListener("keydown",n=>{n.key===" "&&(s.resources.game.deltaT=1/20)}),window.addEventListener("keyup",n=>{n.key===" "&&(s.resources.game.deltaT=1/60)})},N=2*Math.PI,Z=m*2,k="rgb(9, 7, 56)",J=s=>{const{canvas:t,context:e}=s.resources;e.clearRect(0,0,s.resources.canvas.width,t.height),e.fillStyle=k,e.fillRect(0,0,t.width,t.height)},x=(s,t,e,n)=>{s.beginPath(),s.fillStyle=n,s.arc(t.x,t.y,e,0,N),s.closePath(),s.fill()},Q=s=>{for(const[{position:t},e]of s.queryIter("body","shape","attractor"))e.kind==="circle"&&x(s.resources.context,i.v1.copy(t).addMut(s.resources.game.camera.offset),e.radius,e.color)},V=s=>{for(const[{position:t},e]of s.queryIter("body","shape","movement"))if(e.kind==="circle"){const n=i.v1.copy(t).addMut(s.resources.game.camera.offset);x(s.resources.context,n,e.radius,e.color)}},tt=s=>{const{context:t,action:e}=s.resources,n=s.resources.game.camera.offset;if(e.start.x<1/0){const o=i.v1.copy(e.start).subMut(e.end).timesMut(.5).limitMut(e.maxLength);for(const[r,{position:a}]of s.queryIter("movement","body"))t.beginPath(),t.strokeStyle="rgb(255, 255, 255)",t.moveTo(a.x+n.x,a.y+n.y),t.lineTo(a.x+n.x+o.x,a.y+n.y+o.y),t.closePath(),t.stroke()}},et=s=>{const{context:t}=s.resources,e=s.resources.game.camera.offset;for(const[{target:n}]of s.queryIter("target"))t.beginPath(),t.fillStyle=k,t.arc(n.x+e.x,n.y+e.y,Z,0,N),t.closePath(),t.fill()},st="rgb(234, 231, 163)",nt=s=>{const{context:t,stars:e}=s.resources,n=s.resources.game.camera.offset;for(const o of e.visibleTiles(n,t.canvas.width,t.canvas.height))for(const{center:r,radius:a}of o.stars){const f=n.x-r.x+t.canvas.width-b.TILE_SIZE,d=n.y-r.y+t.canvas.height-b.TILE_SIZE;x(t,i.v1.set(f,d),a,st)}},ot=I(J,nt,Q,et,V,tt),rt=(s,t,e,n)=>{const o=i.v1.copy(s).subMut(e),r=1e-5*(n*t/o.lengthSq());return o.normalizeMut().timesMut(r)},at=s=>{const t=s.queryIter("active","movement","body"),e=s.resources.game.deltaT;for(const[n,{velocity:o,acceleration:r},{position:a,mass:f}]of t){for(const[d,{position:y,mass:g}]of s.queryIter("attractor","body")){const M=rt(y,g,a,f);r.addMut(M.divMut(f))}o.addMut(i.v1.copy(r).timesMut(e)),a.addMut(i.v1.copy(o).timesMut(e)),r.set(0,0)}},ft=s=>{const t=s.queryIter("active","movement","body","shape");for(const[e,{velocity:n,prevPosition:o},{position:r},a,f]of t)for(const[d,{position:y},g,M]of s.queryIter("attractor","body","shape")){const T=a.radius+g.radius;if(r.distSq(y)<=T**2){const L=i.v1.copy(r).subMut(y).normalizeMut(),P=i.v2.copy(y).addMut(i.v3.copy(L).timesMut(T));n.reflectMut(L).timesMut(.8);const p=s.getComponent(M,"target");p&&p.target.distSq(r)<=Z**2&&(P.copy(p.target),s.resources.game.nextLevel()),r.copy(P),o.distSq(r)<.3&&s.removeComponent(f,"active");break}}},w=I(at,ft),it=100,ct=s=>{const t=s.resources.game.camera,e=s.query("movement","body");if(e.length===1){const[n,{position:o}]=e[0],{canvas:r}=s.resources,a=i.v1.set(0,0);o.x<0&&(a.x=-o.x),o.x>r.width&&(a.x=-(o.x-r.width)),o.y<0&&(a.y=-o.y),o.y>r.height&&(a.y=-(o.y-r.height)),(a.x!==0||a.y!==0)&&a.addMut(i.v2.set(r.width/2,r.height/2).subMut(o).normalizeMut().timesMut(it)),t.targetOffset.copy(a),t.offset.addMut(i.v2.copy(t.targetOffset).subMut(t.offset).timesMut(.06))}};class dt{constructor(){l(this,"app");l(this,"canvas");l(this,"camera");l(this,"deltaT",1/60);const t=document.createElement("canvas");this.canvas=t,t.width=window.innerWidth,t.height=window.innerHeight;const e=t.getContext("2d"),n=window.devicePixelRatio;if(t.style.width=window.innerWidth+"px",t.style.height=window.innerHeight+"px",t.width=Math.floor(window.innerWidth*n),t.height=Math.floor(window.innerHeight*n),e===null)throw"could not get canvas 2d context";e.scale(n,n),this.camera={offset:c(0,0),targetOffset:c(0,0)},this.app=R({canvas:t,context:e,action:{start:c(1/0,1/0),end:c(1/0,1/0),maxLength:150},game:this,stars:new b}).addStartupSystem($).addSystem(w).addSystem(ot).addSystem(ct),this.nextLevel(!0)}nextLevel(t=!1){const e=I(X(Math.round(S(4,2))),Y(1));this.app.removeSystem(w),setTimeout(()=>{this.app.clearEntities(),this.app.resources.stars.clear(),e(this.app),this.app.addSystem(w)},t?0:1e3)}run(){this.app.run()}}const E=new dt;E.run();document.body.appendChild(E.canvas);window.game=E;
